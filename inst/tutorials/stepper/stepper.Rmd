---
title: "Stepper"
output:
  learnr::tutorial:
    css: css/custom_css.css
runtime: shiny_prerendered
---

```{r setup, include = FALSE}
library(learnr)
library(reticulate)
library(tidyverse)
library(xfun)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
# this package library which should import all the custom functionality we need for doc
library(DataTutor)

nba_data_path <- here::here("inst/tutorials/stepper/data/nba.csv")
modified_color <- "#c6c0fd"
inserted_color <- "#c8ff9e"
deleted_color <- "#fea5a3"
codeify <- function(x) paste0("`", x, "`")

# this is if publishing to shinyapps.io
if (Sys.info()[['user']] == 'shiny'){
  # grab system environment variables set by .Rprofile
  virtualenv_dir = Sys.getenv('VIRTUALENV_NAME')
  python_path = Sys.getenv('PYTHON_PATH')
  # create a virtualenv, install dependences within it, and finally use the virtualenv
  reticulate::virtualenv_create(envname = virtualenv_dir, python = python_path)
  reticulate::virtualenv_install(virtualenv_dir, packages = c('numpy', 'pandas'))
  reticulate::use_virtualenv(virtualenv_dir, required = TRUE)
}
```


# Demo

<!-- Future: you could even make a stepper template or addin that can generate the essential knitr chunks -->

```{python nba_stepper-warmup, include=FALSE}
import pandas as pd
import numpy as np
nba = pd.read_csv(r.nba_data_path)
column_names = {
  'Date': 'date',
  'Start (ET)': 'start',
  'Unamed: 2': 'box',
  'Visitor/Neutral': 'away_team',
  'PTS': 'away_points',
  'Home/Neutral': 'home_team',
  'PTS.1': 'home_points',
  'Unamed: 7': 'n_ot'
}
```

```{python nba_stepper-code, include=FALSE, eval=FALSE}
nba = (nba.rename(columns=column_names)
  .dropna(thresh=4)
  [['date', 'away_team', 'away_points', 'home_team', 'home_points']]
  .assign(date=lambda x: pd.to_datetime(x['date'], format='%a, %b %d, %Y'))
  .set_index('date', append=True)
  .rename_axis(["game_id", "date"])
  .sort_index()
)
```

## Stepper + textual / output annotations

<!-- Old version: -->

```{r nba_stepper, echo=FALSE}
stepper(
  start_expr = "nba.rename(columns=column_names)",
  explanations = list(
    explain(
      "First, the old columns `r color_text(c('date', 'start', 'box', 'away_team', 'away_points', 'home_team', 'home_points'), 'modified')` are renamed using <a href='https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.rename.html' target='_blank'>`r kableExtra::text_spec(codeify('rename'), popover = 'Alter axes labels. Function / dict values must be unique (1-to-1). Labels not contained in a dict / Series will be left as-is. Extra labels listed donâ€™t throw an error. Click for more details.')`</a> and supplying our earlier `r color_text('column_names', 'highlighted')` dict. Some of these columns are now more readable."
      # callout_col_labels(2:7, "black", modified_color)
    )
    # explain(
    #   "Testing: Rows `r color_text('1 and 2', 'inserted')` are green. Columns `r color_text('date', 'deleted')` and `r color_text('start', 'deleted')` are red. Column labels `r color_text(c('away_team', 'home_team'), 'modified')` are purple."
    #   # callout_col_labels(c(4, 6), background = modified_color),
    #   # callout_rows(2:3, background = inserted_color),
    #   # callout_cols(3:4, color = "white", background = deleted_color)
    # )
  )
)
```

<!-- TODO: New version -->

<!-- ```{r nba_stepper, echo=FALSE} -->
<!-- stepper( -->
<!--   start_expr = "nba.rename(columns=column_names)", -->
<!--   explanations = list( -->
<!--     code_summary( -->
<!--       "We create a variable ", callout_text("nba"), " to store the final DataFrame. First, we ", -->
<!--       callout_text("rename"), " the original ", callout_text("columns"), " by supplying the ", -->
<!--       callout_text("column_names"), " dictionary" -->
<!--     ) -->

<!--   ) -->
<!-- ) -->

<!-- ``` -->
